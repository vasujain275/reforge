# ============================================================================
# REFORGE API SERVER CONFIGURATION
# ============================================================================
# This file contains environment variables for the Reforge backend API server.
# Copy this file to .env and customize the values for your environment.
#
# Quick Start:
#   cp .env.example .env
#   vim .env  # Edit values
#   task dev  # Start development server
#
# Production Deployment:
#   1. Set strong JWT_SECRET (use: openssl rand -base64 32)
#   2. Configure DATABASE_URL with production PostgreSQL instance
#   3. Change SEED_ADMIN_PASSWORD immediately after first login
#   4. Set ENV='prod' for production mode
# ============================================================================

# ============================================================================
# SERVER CONFIGURATION
# ============================================================================

# Server bind address and port
# Development: 0.0.0.0:9173 (accessible from host)
# Production: 0.0.0.0:9173 (typically behind reverse proxy)
ADDR='0.0.0.0:9173'

# Environment mode: 'dev' or 'prod'
# - dev: Enables detailed logging, CORS for localhost, hot reload
# - prod: Production optimizations, stricter security
ENV='dev'

# ============================================================================
# CORS CONFIGURATION
# ============================================================================

# Allowed origins for Cross-Origin Resource Sharing (CORS)
# Development: Include both Vite dev server (5173) and preview (4173)
# Production: Set to your deployed frontend domain
#
# Examples:
#   Dev:  http://localhost:5173,http://localhost:4173
#   Prod: https://reforge.yourcompany.com
CORS_ALLOWED_ORIGINS='http://localhost:5173,http://localhost:4173'

# ============================================================================
# DATABASE CONFIGURATION (PostgreSQL 18)
# ============================================================================

# PostgreSQL connection string (libpq format)
# Format: postgresql://[user[:password]@][host][:port][/dbname][?param1=value1&...]
#
# Development (Docker):
#   postgresql://reforge:password@localhost:5432/reforge?sslmode=disable
#
# Production:
#   postgresql://reforge:${DB_PASSWORD}@postgres-host:5432/reforge?sslmode=require
#
# Connection Parameters:
#   - sslmode: disable (dev) | require (prod) | verify-full (strict)
#   - pool_max_conns: Maximum connections (default: managed by pgxpool)
#   - pool_min_conns: Minimum idle connections
#   - pool_max_conn_lifetime: Max connection lifetime (e.g., 1h)
DATABASE_URL='postgresql://reforge:password@localhost:5432/reforge?sslmode=disable'

# Database password (used in docker-compose.yaml and migrations)
# Generate strong password: openssl rand -base64 32
DB_PASSWORD='password'

# Goose migration configuration
# Driver: postgres (for PostgreSQL)
# Migration directory: Location of .sql migration files
GOOSE_DRIVER='postgres'
GOOSE_MIGRATION_DIR='./internal/adapters/postgres/migrations'

# ============================================================================
# AUTHENTICATION & SECURITY
# ============================================================================

# JWT Secret for signing authentication tokens
# SECURITY WARNING: Change this before deploying to production!
# Generate secure secret: openssl rand -base64 32
#
# This secret is used to sign:
#   - Access tokens (short-lived, 15 min)
#   - Refresh tokens (long-lived, 7 days)
#
# If changed, all existing tokens will be invalidated (users must re-login)
JWT_SECRET='super-secret-default-key-CHANGE-ME-IN-PRODUCTION'

# ============================================================================
# SCORING ALGORITHM WEIGHTS
# ============================================================================

# Reforge uses a deterministic 7-feature weighted scoring formula to rank
# problems for revision. These weights determine how much each factor
# contributes to the urgency score.
#
# Features:
#   W_CONF       - Confidence level (lower confidence = higher priority)
#   W_DAYS       - Days since last attempt (adaptive spacing)
#   W_ATTEMPTS   - Total attempt count (less practiced = higher priority)
#   W_TIME       - Average solution time (slower = needs practice)
#   W_DIFFICULTY - Problem difficulty (balanced selection)
#   W_FAILED     - Failure rate (struggled problems prioritized)
#   W_PATTERN    - Pattern weakness (weak categories highlighted)
#
# Constraints:
#   - All weights should sum to 1.0 for optimal scoring
#   - Valid range: 0.0 to 1.0 per weight
#   - Admins can customize these at runtime via the UI
#
# Default Configuration (Balanced):
DEFAULT_W_CONF='0.30'       # 30% - Your confidence level
DEFAULT_W_DAYS='0.20'       # 20% - Time since last attempt
DEFAULT_W_ATTEMPTS='0.10'   # 10% - Number of attempts
DEFAULT_W_TIME='0.05'       #  5% - Solution time
DEFAULT_W_DIFFICULTY='0.15' # 15% - Problem difficulty
DEFAULT_W_FAILED='0.10'     # 10% - Failure rate
DEFAULT_W_PATTERN='0.10'    # 10% - Pattern weakness

# ============================================================================
# ADMIN SEEDING CONFIGURATION
# ============================================================================

# First-time setup: Automatically create an admin user if none exists
# This happens ONLY on the first application startup when the database is empty.
#
# SECURITY WARNING: Change these values before deploying to production!
# After the admin is seeded, you can (and should) change the password via:
#   1. Login with these credentials
#   2. Go to Settings → Change Password
#   3. Set a strong password
#
# Recommended: Use /onboarding endpoint for first-time setup instead

# Admin email (used for login)
SEED_ADMIN_EMAIL='admin@reforge.local'

# Admin display name
SEED_ADMIN_NAME='System Administrator'

# Admin password (CHANGE THIS!)
# Requirements: At least 8 characters
SEED_ADMIN_PASSWORD='ChangeMeImmediately123!'

# ============================================================================
# APPLICATION SIGNUP SETTINGS
# ============================================================================

# Control user registration behavior on application startup.
# These are DEFAULT values - admins can change them at runtime via the admin dashboard.
#
# Scenarios:
#   1. Open Registration:
#      DEFAULT_SIGNUP_ENABLED=true, DEFAULT_INVITE_CODES_ENABLED=false
#      → Anyone can register without invite codes
#
#   2. Invite-Only:
#      DEFAULT_SIGNUP_ENABLED=true, DEFAULT_INVITE_CODES_ENABLED=true
#      → Users need admin-generated invite codes to register
#
#   3. Closed Registration:
#      DEFAULT_SIGNUP_ENABLED=false, DEFAULT_INVITE_CODES_ENABLED=false
#      → Only admins can create users manually

# Allow new user registrations (true/false)
DEFAULT_SIGNUP_ENABLED='true'

# When signup is disabled, allow admin-generated invite codes (true/false)
DEFAULT_INVITE_CODES_ENABLED='true'

# ============================================================================
# DATA IMPORT CONFIGURATION
# ============================================================================

# Path to bundled CSV datasets for bulk problem import
# Default: ./sample-datasets (contains leetcode.csv with 2000+ problems)
#
# Admins can import problems via:
#   - /admin/data/import/datasets (bundled datasets)
#   - /admin/data/import/parse-upload (custom CSV upload)
DATASET_PATH='./sample-datasets'

# ============================================================================
# OPTIONAL: ADVANCED CONFIGURATION
# ============================================================================

# Uncomment and customize these if needed:

# PostgreSQL Connection Pool Settings (managed by pgxpool)
# PG_POOL_MAX_CONNS='25'          # Max concurrent connections
# PG_POOL_MIN_CONNS='5'            # Min idle connections
# PG_POOL_MAX_CONN_LIFETIME='5m'   # Max connection lifetime
# PG_POOL_MAX_CONN_IDLE_TIME='30s' # Max idle time before cleanup

# Logging Configuration
# LOG_LEVEL='info'  # debug | info | warn | error
# LOG_FORMAT='text' # text | json

# Rate Limiting (future feature)
# RATE_LIMIT_ENABLED='true'
# RATE_LIMIT_REQUESTS_PER_MINUTE='100'

# ============================================================================
# MIGRATION FROM SQLITE
# ============================================================================

# If you're migrating from SQLite, see docs/POSTGRES_MIGRATION.md
# Use the migration script:
#   python3 scripts/migrate_sqlite_to_postgres.py \
#     --sqlite-db ./reforge.db \
#     --postgres-url "${DATABASE_URL}"

