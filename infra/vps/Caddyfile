# ============================================================================
# Caddy Configuration for Reforge API - Blue-Green Deployment
# Automatic HTTPS with Let's Encrypt
# Health-check based routing with automatic failover
# ============================================================================

# Global options
{
	# Email for Let's Encrypt certificate notifications
	email admin@vasujain.me
	
	# Enable admin API on localhost only (for metrics and health checks)
	admin localhost:2019
}

# ============================================================================
# Main API Domain - reforge-api.vasujain.me
# ============================================================================
reforge-api.vasujain.me {
	# Reverse proxy with health-based load balancing
	reverse_proxy {
		# Both blue and green backends
		# Caddy will automatically route to healthy backends
		to reforge-api-blue:9173 reforge-api-green:9173
		
		# Health check configuration
		health_uri /api/v1/health
		health_interval 5s
		health_timeout 2s
		health_status 200
		
		# Load balancing policy: use first healthy backend
		# This ensures we always route to a working container
		lb_policy first
		
		# Failover configuration
		lb_try_duration 2s
		lb_try_interval 250ms
		
		# Pass through real client IP
		header_up X-Real-IP {remote_host}
		header_up X-Forwarded-For {remote_host}
		header_up X-Forwarded-Proto {scheme}
	}
	
	# CORS headers for Cloudflare Pages frontend
	header {
		# Allow requests from your frontend domain
		Access-Control-Allow-Origin "https://reforge.vasujain.me"
		Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS, PATCH"
		Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With"
		Access-Control-Allow-Credentials "true"
		Access-Control-Max-Age "3600"
		
		# Security headers
		X-Content-Type-Options "nosniff"
		X-Frame-Options "DENY"
		X-XSS-Protection "1; mode=block"
		Referrer-Policy "strict-origin-when-cross-origin"
		Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
		
		# Remove server identification
		-Server
	}
	
	# Handle OPTIONS preflight requests
	@options {
		method OPTIONS
	}
	handle @options {
		header Access-Control-Allow-Origin "https://reforge.vasujain.me"
		header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS, PATCH"
		header Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With"
		header Access-Control-Allow-Credentials "true"
		header Access-Control-Max-Age "3600"
		respond 204
	}
	
	# Enable compression for better performance
	encode gzip zstd
	
	# Access logging in JSON format
	log {
		output file /var/log/caddy/reforge-api-access.log {
			roll_size 100mb
			roll_keep 5
			roll_keep_for 720h
		}
		format json {
			time_format "iso8601"
		}
		level INFO
	}
	
	# Error handling
	handle_errors {
		@503 expression {http.error.status_code} == 503
		handle @503 {
			respond "{\"error\": \"API temporarily unavailable during deployment\"}" 503 {
				header Content-Type "application/json"
			}
		}
		
		@500 expression {http.error.status_code} == 500
		handle @500 {
			respond "{\"error\": \"Internal server error\"}" 500 {
				header Content-Type "application/json"
			}
		}
		
		# Generic error handler
		respond "{\"error\": \"An error occurred\"}" {http.error.status_code} {
			header Content-Type "application/json"
		}
	}
}

# ============================================================================
# Caddy Admin API Health Endpoint (localhost only)
# Used for monitoring Caddy itself
# ============================================================================
:2019 {
	respond /health 200 {
		body "OK"
	}
}
