# ============================================================================
# REFORGE API PRODUCTION ENVIRONMENT CONFIGURATION
# Blue-Green Deployment with Zero-Downtime Updates
# ============================================================================
# This file contains environment variables for Reforge API deployment.
# Copy this file to .env and customize the values.
#
# Quick Start:
#   cp .env.sample .env
#   vim .env  # Edit all REQUIRED fields below
#   docker compose up -d
#
# Domain: reforge-api.vasujain.me
# Frontend: https://reforge.vasujain.me (Cloudflare Pages)
# Database: PostgreSQL 18 Alpine (local on VPS)
# Proxy: Traefik (global instance)
# ============================================================================

# ============================================================================
# REQUIRED SECRETS - MUST BE CHANGED BEFORE DEPLOYMENT
# ============================================================================

# JWT Secret for authentication tokens
# CRITICAL: This MUST match the secret used by your frontend!
# Generate a strong random secret:
#   openssl rand -base64 32
JWT_SECRET=your-super-secret-jwt-key-change-me-CRITICAL

# PostgreSQL Database Password
# CRITICAL: Generate a strong random password for production!
# Generate: openssl rand -base64 32
POSTGRES_PASSWORD=your-strong-database-password-change-me-CRITICAL

# ============================================================================
# API DOMAIN CONFIGURATION
# ============================================================================

# API domain (must be configured in DNS and match Traefik routing)
# This is used by Traefik to route requests to the API
API_DOMAIN=reforge-api.vasujain.me

# ============================================================================
# DATABASE CONFIGURATION
# ============================================================================

# PostgreSQL database name
# Default: reforge (recommended to keep default)
POSTGRES_DB=reforge

# PostgreSQL username
# Default: reforge (recommended to keep default)
POSTGRES_USER=reforge

# Note: DATABASE_URL is automatically constructed from above values
# Format: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}?sslmode=disable
# No need to set it manually - docker-compose handles this

# ============================================================================
# BLUE-GREEN DEPLOYMENT CONFIGURATION
# ============================================================================

# Docker image versions for blue and green slots
# During deployment, the inactive slot gets the new version
# After successful health checks, Traefik routes traffic to healthy containers
BLUE_VERSION=latest
GREEN_VERSION=latest

# Active deployment slot (blue or green)
# This is managed by the deployment script - do not change manually
ACTIVE_COLOR=blue

# ============================================================================
# SERVER CONFIGURATION
# ============================================================================

# Server bind address (inside containers)
# Default: :9173 (listens on all interfaces inside container)
ADDR=:9173

# Environment mode
# Always use 'prod' for VPS deployments
ENV=prod

# ============================================================================
# SCORING ALGORITHM WEIGHTS (OPTIONAL)
# ============================================================================

# Reforge uses a deterministic 7-feature weighted scoring formula.
# These values should sum to 1.0 for optimal scoring.
# Admins can customize these at runtime via the UI.
#
# Defaults (if not set):
DEFAULT_W_CONF=0.30
DEFAULT_W_DAYS=0.20
DEFAULT_W_ATTEMPTS=0.10
DEFAULT_W_TIME=0.05
DEFAULT_W_DIFFICULTY=0.15
DEFAULT_W_FAILED=0.10
DEFAULT_W_PATTERN=0.10

# ============================================================================
# SIGNUP SETTINGS (OPTIONAL)
# ============================================================================

# Allow new user registrations (true/false)
# Recommended: false for production (use invite codes instead)
DEFAULT_SIGNUP_ENABLED=false

# Allow admin-generated invite codes when signup is disabled (true/false)
# Recommended: true for controlled access
DEFAULT_INVITE_CODES_ENABLED=true

# ============================================================================
# ADVANCED SETTINGS
# ============================================================================

# Dataset path (bundled CSV datasets for import)
# Default path inside container - do not change unless you know what you're doing
DATASET_PATH=/app/sample-datasets

# ============================================================================
# DEPLOYMENT NOTES
# ============================================================================
#
# Initial Setup:
#   1. Copy this file: cp .env.sample .env
#   2. Edit .env with your actual values (JWT_SECRET, POSTGRES_PASSWORD, API_DOMAIN)
#   3. Ensure DNS: reforge-api.vasujain.me points to this server's IP
#   4. Ensure Traefik is running (see ../traefik/README.md)
#   5. Create backups directory: mkdir -p backups
#   6. Start services: docker compose up -d
#   7. Check logs: docker compose logs -f
#   8. Verify HTTPS: curl https://reforge-api.vasujain.me/api/v1/health
#
# Database Backup:
#   - Automated: ./backup.sh (creates timestamped backup in ./backups/)
#   - Manual: docker exec reforge-postgres pg_dump -U reforge reforge > backup.sql
#   - Restore: cat backup.sql | docker exec -i reforge-postgres psql -U reforge -d reforge
#
# Updating:
#   - Use the deploy.sh script or GitHub Actions workflow
#   - Never manually edit BLUE_VERSION, GREEN_VERSION, or ACTIVE_COLOR
#   - Always verify health checks pass after deployment
#
# Monitoring:
#   - Health check: curl https://reforge-api.vasujain.me/api/v1/health
#   - Container status: docker compose ps
#   - API logs: docker compose logs -f reforge-api-blue reforge-api-green
#   - Database logs: docker compose logs -f postgres
#   - Traefik dashboard: https://dashboard.vasujain.me
#
# Rollback:
#   - If deployment fails, Traefik keeps routing to healthy container
#   - Manual rollback: ./deploy.sh rollback
#   - Or switch versions in .env and: docker compose up -d
#
# ============================================================================
